stages:

  extract_calibration_images:
    cmd: python scripts/camera_calibration.py extract-calibration-images --video_dir data/raw/calibration/video/calibration.MOV --path_to_images_folder data/raw/calibration/images --amount_of_frames 30
    deps:
      - scripts/camera_calibration.py
      - data/raw/calibration/video
    outs:
      - data/raw/calibration/images

  camera_calibration:
    cmd: python scripts/camera_calibration.py calibrate --image_dir data/raw/calibration/images --image_format jpg --output_path data/processed/colmap_db/colmap_text/ --square_size 2.5
    deps:
      - scripts/camera_calibration.py
      - data/raw/calibration/images
    outs:
      - data/processed/colmap_db/colmap_text/cameras.txt

  extract_images_from_video:
    cmd: python scripts/image_preprocessing.py extract-images-from-video --path_to_video data/raw/video/video.MP4 --path_to_images_folder data/raw/images --amount_of_frames 50 --metadata data/raw/meta/meta.json --colmap_text_folder data/processed/colmap_db/colmap_text
    deps:
      - scripts/image_preprocessing.py
      - data/raw/video
      - data/processed/colmap_db/colmap_text/cameras.txt
    outs:
      - data/raw/images
      - data/processed/colmap_db/colmap_text/images.txt

  crop_and_resize_images:
    cmd: python scripts/image_preprocessing.py crop-resize-images --path_to_images_folder data/raw/images --path_to_cropped_images_folder data/interim/
    deps:
      - scripts/image_preprocessing.py
      - data/raw/images
    outs:
      - data/interim

  remove_background:
    cmd: python scripts/image_preprocessing.py remove-background --path_to_cropped_images_folder data/interim/ --images_no_background data/processed/images --model_type new
    deps:
      - checkpoints/u2net.pth
      - scripts/image_preprocessing.py
      - data/interim/
    outs:
      - data/processed/images/

  # colmap:
  #   cmd: python scripts/run_colmap.py --images data/interim --colmap_db data/processed/colmap_db/colmap.db --text data/processed/colmap_db/colmap_text  --colmap_matcher sequential
  #   deps:
  #     - scripts/run_colmap.py
  #     - data/processed/images
  #   outs:
  #     - data/processed/colmap_db/

  colmap2nerf:
    cmd: python scripts/colmap2nerf.py --image_folder data/processed/images --colmap_text_folder data/processed/colmap_db/colmap_text --output data/processed/configs/nerf_transforms.json
    deps:
      - data/processed/images/
      - scripts/colmap2nerf.py
      - data/processed/colmap_db/
    outs:
      - data/processed/configs/nerf_transforms.json

  reconstruction:
   cmd: python scripts/reconstruction.py --ref_mesh data/processed/configs --out_dir data/results
   params:
     - iter
     - batch
     - spp
     - layers
     - train_res
     - texture_res
     - save_interval
     - learning_rate
   metrics:
     - data/results/metrcis.json
   deps:
     - data/processed/irrmaps
     - data/processed/tets
     - scripts/reconstruction.py
     - data/processed/configs/nerf_transforms.json
   outs:
     - data/results/eval_mesh/
     - data/results/dmtet_mesh/
     - data/results/mesh/